<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JustHTML Playground - JavaScript</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
      min-height: 100vh;
    }
    h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
    .subtitle { text-align: center; color: #666; margin-bottom: 20px; }
    .subtitle a { color: #3498db; }
    .container { max-width: 1200px; margin: 0 auto; }
    .status-bar {
      background: #fff;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status {
      font-size: 14px;
      padding: 4px 12px;
      border-radius: 4px;
      background: #f39c12;
      color: #fff;
    }
    .status.ready { background: #27ae60; }
    .status.error { background: #e74c3c; }
    .input-section,
    .mode-section,
    .examples-section {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .input-tabs, .mode-tabs, .example-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    .tab-btn, .mode-btn, .example-btn {
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .tab-btn {
      background: #3498db;
      color: #fff;
      padding: 10px 20px;
    }
    .tab-btn.active { background: #2c3e50; }
    .tab-btn:hover:not(.active) { background: #2980b9; }
    .mode-btn { background: #ecf0f1; color: #2c3e50; }
    .mode-btn.active { background: #9b59b6; color: #fff; }
    .mode-btn:hover:not(.active) { background: #dde4e6; }
    .example-btn { background: #ecf0f1; color: #2c3e50; }
    .example-btn:hover { background: #dde4e6; }
    .tab-content, .mode-options { display: none; }
    .tab-content.active, .mode-options.active { display: block; }
    .url-input-row, .selector-input { display: flex; gap: 10px; }
    .url-input-row input, .selector-input input { flex: 1; }
    input[type="text"], input[type="url"], textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }
    textarea {
      height: 200px;
      font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
      font-size: 14px;
      resize: vertical;
      line-height: 1.5;
    }
    input:focus, textarea:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
    }
    button {
      background: #3498db;
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    button:hover { background: #2980b9; }
    button:disabled { background: #bdc3c7; cursor: not-allowed; }
    .run-btn { background: #27ae60; }
    .run-btn:hover { background: #229954; }
    .output-section {
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .output-header {
      background: #2c3e50;
      color: #fff;
      padding: 12px 20px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .output-content {
      padding: 20px;
      min-height: 200px;
      max-height: 500px;
      overflow: auto;
      font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
      background: #fafafa;
    }
    .output-content.error { background: #fdf2f2; color: #c0392b; }
    .match-count {
      background: #27ae60;
      color: #fff;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
    }
    .info-box {
      background: #e8f4fd;
      border-left: 4px solid #3498db;
      padding: 15px;
      margin-top: 20px;
      border-radius: 0 8px 8px 0;
      font-size: 14px;
    }
    .info-box a { color: #3498db; }
    @media (max-width: 600px) {
      body { padding: 10px; }
      .input-tabs, .mode-tabs, .example-buttons { flex-direction: column; }
      .tab-btn, .mode-btn, .example-btn { width: 100%; }
      .url-input-row, .selector-input { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>JustHTML Playground</h1>
    <p class="subtitle">JavaScript playground for <a href="https://github.com/ozenhati/justjshtml" target="_blank">justjshtml</a></p>

    <div class="status-bar">
      <span>JavaScript Environment</span>
      <span id="status" class="status">Loading modules...</span>
    </div>

    <div class="input-section">
      <div class="input-tabs">
        <button class="tab-btn active" data-tab="paste">Paste HTML</button>
        <button class="tab-btn" data-tab="url">Fetch from URL</button>
      </div>

      <div id="paste-tab" class="tab-content active">
        <textarea id="html-input" placeholder="Paste your HTML here..."><!DOCTYPE html>
<html>
<head>
    <title>Example Page</title>
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="/" class="active">Home</a></li>
                <li><a href="/about">About</a></li>
                <li><a href="/contact">Contact</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <article>
            <h1>Welcome to JustHTML</h1>
            <p class="intro">A <strong>pure JavaScript</strong> HTML5 parser.</p>
            <p>It aims for html5lib tree-construction compatibility.</p>
        </article>
        <aside>
            <h2>Features</h2>
            <ul>
                <li>CSS Selectors</li>
                <li>Tree Traversal</li>
                <li>Pretty Printing</li>
            </ul>
        </aside>
    </main>
    <footer>
        <p>&copy; 2026 Example</p>
    </footer>
</body>
</html></textarea>
      </div>

      <div id="url-tab" class="tab-content">
        <div class="url-input-row">
          <input type="url" id="url-input" placeholder="https://example.com (must support CORS)">
          <button id="fetch-btn" disabled>Fetch</button>
        </div>
        <p style="font-size: 12px; color: #888; margin-top: 8px;">Note: The URL must support CORS.</p>
      </div>
    </div>

    <div class="mode-section">
      <h3>Playground Mode</h3>
      <div class="mode-tabs">
        <button class="mode-btn active" data-mode="selector">CSS Selector Query</button>
        <button class="mode-btn" data-mode="pretty">Pretty Print HTML</button>
        <button class="mode-btn" data-mode="tree">Tree Structure</button>
        <button class="mode-btn" data-mode="stream">Stream Events</button>
        <button class="mode-btn" data-mode="text">Extract Text</button>
        <button class="mode-btn" data-mode="markdown">To Markdown</button>
      </div>

      <div id="selector-options" class="mode-options active">
        <label for="selector-input">CSS Selector:</label>
        <div class="selector-input">
          <input type="text" id="selector-input" placeholder="e.g., p.intro, nav ul li a, h1, h2, h3" value="p">
          <button id="run-btn" class="run-btn" disabled>Run Query</button>
        </div>
      </div>

      <div id="pretty-options" class="mode-options"><button id="pretty-btn" class="run-btn" disabled>Pretty Print</button></div>
      <div id="tree-options" class="mode-options"><button id="tree-btn" class="run-btn" disabled>Show Tree</button></div>
      <div id="stream-options" class="mode-options"><button id="stream-btn" class="run-btn" disabled>Show Events</button></div>

      <div id="text-options" class="mode-options">
        <label for="text-selector-input">CSS Selector (optional - leave empty for whole document):</label>
        <div class="selector-input">
          <input type="text" id="text-selector-input" placeholder="e.g., article, main, .content (or leave empty)">
          <button id="text-btn" class="run-btn" disabled>Extract Text</button>
        </div>
      </div>

      <div id="markdown-options" class="mode-options">
        <label for="markdown-selector-input">CSS Selector (optional - leave empty for whole document):</label>
        <div class="selector-input">
          <input type="text" id="markdown-selector-input" placeholder="e.g., article, main, .content (or leave empty)">
          <button id="markdown-btn" class="run-btn" disabled>Convert to Markdown</button>
        </div>
      </div>
    </div>

    <div class="output-section">
      <div class="output-header">
        <span>Output</span>
        <span id="match-count" class="match-count" style="display:none;">0 matches</span>
      </div>
      <div id="output" class="output-content">Results will appear here...</div>
    </div>

    <div class="examples-section">
      <h3>Example Selectors</h3>
      <div class="example-buttons">
        <button class="example-btn" data-selector="a">All Links (a)</button>
        <button class="example-btn" data-selector="p.intro">Intro Paragraphs (p.intro)</button>
        <button class="example-btn" data-selector="nav > ul > li">Nav Items (nav > ul > li)</button>
        <button class="example-btn" data-selector="h1, h2, h3">All Headings (h1, h2, h3)</button>
        <button class="example-btn" data-selector="[href]">Elements with href</button>
        <button class="example-btn" data-selector="li:first-child">First List Items</button>
      </div>
    </div>

    <div class="info-box">
      <strong>About JustJSHTML:</strong> Dependency-free JavaScript HTML parser inspired by JustHTML.
      <a href="https://github.com/ozenhati/justjshtml" target="_blank">View source on GitHub</a>
    </div>
  </div>

  <script type="module">
    import { JustHTML, stream } from "./src/index.js";

    const statusEl = document.getElementById("status");
    const outputEl = document.getElementById("output");
    const matchCountEl = document.getElementById("match-count");
    const htmlInputEl = document.getElementById("html-input");
    const urlInputEl = document.getElementById("url-input");
    const selectorInputEl = document.getElementById("selector-input");
    const textSelectorInputEl = document.getElementById("text-selector-input");
    const markdownSelectorInputEl = document.getElementById("markdown-selector-input");

    const runBtn = document.getElementById("run-btn");
    const prettyBtn = document.getElementById("pretty-btn");
    const treeBtn = document.getElementById("tree-btn");
    const streamBtn = document.getElementById("stream-btn");
    const textBtn = document.getElementById("text-btn");
    const markdownBtn = document.getElementById("markdown-btn");
    const fetchBtn = document.getElementById("fetch-btn");

    document.querySelectorAll(".tab-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach((c) => c.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(`${btn.dataset.tab}-tab`).classList.add("active");
      });
    });

    document.querySelectorAll(".mode-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".mode-btn").forEach((b) => b.classList.remove("active"));
        document.querySelectorAll(".mode-options").forEach((o) => o.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(`${btn.dataset.mode}-options`).classList.add("active");
      });
    });

    document.querySelectorAll(".example-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        selectorInputEl.value = btn.dataset.selector;
        document.querySelectorAll(".mode-btn").forEach((b) => b.classList.remove("active"));
        document.querySelectorAll(".mode-options").forEach((o) => o.classList.remove("active"));
        document.querySelector('[data-mode="selector"]').classList.add("active");
        document.getElementById("selector-options").classList.add("active");
        runQuery();
      });
    });

    function setReady() {
      statusEl.textContent = "Ready";
      statusEl.className = "status ready";
      [runBtn, prettyBtn, treeBtn, streamBtn, textBtn, markdownBtn, fetchBtn].forEach((btn) => {
        btn.disabled = false;
      });
    }

    function setError(message) {
      statusEl.textContent = "Error";
      statusEl.className = "status error";
      outputEl.textContent = message;
      outputEl.className = "output-content error";
    }

    function getHtmlInput() {
      return htmlInputEl.value;
    }

    function parseHtml(html) {
      return new JustHTML(html, { collectErrors: true });
    }

    function showOutput(text, isError = false) {
      outputEl.textContent = text;
      outputEl.className = isError ? "output-content error" : "output-content";
    }

    function showCount(text) {
      matchCountEl.textContent = text;
      matchCountEl.style.display = "inline";
    }

    function hideCount() {
      matchCountEl.style.display = "none";
    }

    function renderTree(node, depth = 0, lines = []) {
      const pad = "  ".repeat(depth);
      const attrs = node.attrs || {};
      if (node.name === "#text") {
        const text = (node.data || "").trim();
        if (text) {
          lines.push(`${pad}"${text.length > 50 ? text.slice(0, 47) + "..." : text}"`);
        }
        return lines;
      }
      if (node.name === "#comment") {
        lines.push(`${pad}<!-- ${node.data || ""} -->`);
        return lines;
      }
      if (node.name === "!doctype") {
        lines.push(`${pad}<!DOCTYPE ${node.data?.name || "html"}>`);
        return lines;
      }
      if (node.name.startsWith("#")) {
        for (const child of node.children || []) {
          renderTree(child, depth, lines);
        }
        return lines;
      }
      const attrText = Object.entries(attrs).map(([k, v]) => `${k}="${v}"`).join(" ");
      lines.push(`${pad}<${node.name}${attrText ? " " + attrText : ""}>`);
      for (const child of node.children || []) {
        renderTree(child, depth + 1, lines);
      }
      return lines;
    }

    function markdownFromNode(node) {
      if (!node) return "";
      if (node.name === "#text") return node.data || "";
      if (node.name === "#comment" || node.name === "!doctype") return "";
      if (node.name.startsWith("#")) {
        return (node.children || []).map(markdownFromNode).join("").trim();
      }

      const children = (node.children || []).map(markdownFromNode).join("");
      switch (node.name) {
        case "h1": return `# ${children}\n\n`;
        case "h2": return `## ${children}\n\n`;
        case "h3": return `### ${children}\n\n`;
        case "h4": return `#### ${children}\n\n`;
        case "h5": return `##### ${children}\n\n`;
        case "h6": return `###### ${children}\n\n`;
        case "p": return `${children}\n\n`;
        case "strong":
        case "b": return `**${children}**`;
        case "em":
        case "i": return `*${children}*`;
        case "code": return `\`${children}\``;
        case "br": return "\n";
        case "a": {
          const href = node.attrs?.href || "";
          return href ? `[${children}](${href})` : children;
        }
        case "li": return `- ${children}\n`;
        case "ul":
        case "ol": return `${children}\n`;
        default: return children;
      }
    }

    async function runQuery() {
      const html = getHtmlInput();
      const selector = selectorInputEl.value.trim();
      if (!selector) {
        hideCount();
        showOutput("Please enter a CSS selector");
        return;
      }
      try {
        const doc = parseHtml(html);
        const results = doc.query(selector);
        showCount(`${results.length} match${results.length !== 1 ? "es" : ""}`);
        if (results.length === 0) {
          showOutput(`No elements match the selector "${selector}"`);
          return;
        }
        showOutput(results.map((node) => node.toHTML({ pretty: false })).join("\n\n---\n\n"));
      } catch (error) {
        hideCount();
        showOutput(error.message || String(error), true);
      }
    }

    async function prettyPrint() {
      try {
        const doc = parseHtml(getHtmlInput());
        hideCount();
        showOutput(doc.toHTML({ pretty: true }));
      } catch (error) {
        hideCount();
        showOutput(error.message || String(error), true);
      }
    }

    async function showTree() {
      try {
        const doc = parseHtml(getHtmlInput());
        hideCount();
        showOutput(renderTree(doc.root).join("\n"));
      } catch (error) {
        hideCount();
        showOutput(error.message || String(error), true);
      }
    }

    async function showStreamEvents() {
      try {
        const html = getHtmlInput();
        const events = [];
        for (const [event, data] of stream(html)) {
          if (event === "start") {
            const [tag, attrs] = data;
            const attrText = Object.entries(attrs).map(([k, v]) => `${k}="${v}"`).join(" ");
            events.push(`START: <${tag}${attrText ? " " + attrText : ""}>`);
          } else if (event === "end") {
            events.push(`END:   </${data}>`);
          } else if (event === "text") {
            const text = (data || "").trim();
            if (text) {
              events.push(`TEXT:  "${text.length > 60 ? text.slice(0, 57) + "..." : text}"`);
            }
          } else if (event === "comment") {
            events.push(`COMMENT: <!--${data || ""}-->`);
          } else if (event === "doctype") {
            events.push(`DOCTYPE: ${JSON.stringify(data)}`);
          }
        }
        hideCount();
        showOutput(events.join("\n"));
      } catch (error) {
        hideCount();
        showOutput(error.message || String(error), true);
      }
    }

    async function extractText() {
      const html = getHtmlInput();
      const selector = textSelectorInputEl.value.trim();
      try {
        const doc = parseHtml(html);
        if (!selector) {
          showCount("Whole document");
          showOutput(doc.toText());
          return;
        }
        const results = doc.query(selector);
        showCount(`${results.length} match${results.length !== 1 ? "es" : ""}`);
        if (!results.length) {
          showOutput(`No elements match the selector "${selector}"`);
          return;
        }
        showOutput(results.map((node) => node.toText()).filter(Boolean).join("\n\n---\n\n"));
      } catch (error) {
        hideCount();
        showOutput(error.message || String(error), true);
      }
    }

    async function convertToMarkdown() {
      const html = getHtmlInput();
      const selector = markdownSelectorInputEl.value.trim();
      try {
        const doc = parseHtml(html);
        if (!selector) {
          showCount("Whole document");
          showOutput(markdownFromNode(doc.root).trim());
          return;
        }
        const results = doc.query(selector);
        showCount(`${results.length} match${results.length !== 1 ? "es" : ""}`);
        if (!results.length) {
          showOutput(`No elements match the selector "${selector}"`);
          return;
        }
        showOutput(results.map((node) => markdownFromNode(node).trim()).filter(Boolean).join("\n\n---\n\n"));
      } catch (error) {
        hideCount();
        showOutput(error.message || String(error), true);
      }
    }

    async function fetchUrl() {
      const url = urlInputEl.value.trim();
      if (!url) {
        alert("Please enter a URL");
        return;
      }
      try {
        fetchBtn.disabled = true;
        fetchBtn.textContent = "Fetching...";
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const html = await response.text();
        htmlInputEl.value = html;

        document.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach((c) => c.classList.remove("active"));
        document.querySelector('[data-tab="paste"]').classList.add("active");
        document.getElementById("paste-tab").classList.add("active");

        hideCount();
        showOutput(`Fetched ${html.length} characters from ${url}. Select a mode above to process.`);
      } catch (error) {
        hideCount();
        showOutput(`Failed to fetch URL: ${error.message}\n\nNote: The target URL must have CORS headers that allow cross-origin requests.`, true);
      } finally {
        fetchBtn.disabled = false;
        fetchBtn.textContent = "Fetch";
      }
    }

    runBtn.addEventListener("click", runQuery);
    prettyBtn.addEventListener("click", prettyPrint);
    treeBtn.addEventListener("click", showTree);
    streamBtn.addEventListener("click", showStreamEvents);
    textBtn.addEventListener("click", extractText);
    markdownBtn.addEventListener("click", convertToMarkdown);
    fetchBtn.addEventListener("click", fetchUrl);

    selectorInputEl.addEventListener("keypress", (e) => { if (e.key === "Enter") runQuery(); });
    textSelectorInputEl.addEventListener("keypress", (e) => { if (e.key === "Enter") extractText(); });
    markdownSelectorInputEl.addEventListener("keypress", (e) => { if (e.key === "Enter") convertToMarkdown(); });

    try {
      setReady();
    } catch (error) {
      setError(error.message || String(error));
    }
  </script>
</body>
</html>
